#define ACROSS_PERIODIC(a, b) (fabs(a - b) > L0 / 2.)
#define PERIODIC_1DIST(a, b) (fabs(a - L0 - b) > L0 / 2. ? a + L0 - b : a - L0 - b)
#define GENERAL_1DIST(a, b) (ACROSS_PERIODIC(a, b) ? PERIODIC_1DIST(a, b) : a - b)
#define PERIODIC_1DAVG(a, b) (fabs(a - L0 - b) > L0 / 2. ? a + L0 + b : a - L0 + b)
#define GENERAL_1DAVG(a, b) (ACROSS_PERIODIC(a, b) ? PERIODIC_1DAVG(a, b) : a + b)
#define GENERAL_SQNORM(a, b) (sq(GENERAL_1DIST(a.x, b.x)) + sq(GENERAL_1DIST(a.y, b.y)) + sq(GENERAL_1DIST(a.z, b.z)))

#define POS_PBC_X(X) ((u.x.boundary[left]  != periodic_bc) ? (X) : (((X - (X0 + L0 / 2)) > L0 / 2.) ? (X) - L0 : (X)))
#define POS_PBC_Y(Y) ((u.x.boundary[top]   != periodic_bc) ? (Y) : (((Y - (Y0 + L0 / 2)) > L0 / 2.) ? (Y) - L0 : (Y)))
#define POS_PBC_Z(Z) ((u.x.boundary[front] != periodic_bc) ? (Z) : (((Z - (Z0 + L0 / 2)) > L0 / 2.) ? (Z) - L0 : (Z)))
